# Планирование: анализ, идентификация проблем и поиск решений

## Анализ

### Текущее состояние
Вопросы:
1. новый заказ - по каким критериям заказ считается новым?
2. алгоритм "кто взял новый заказ тот и получит оплату" - может быть проблемой сценария, что приводит к проблемам обработки заказов
3. когда происходит заказ? До расчета стоимости или после? Могут быть потери заказов, когда клиент не ждет расчета или уведомление не пришло? (как предложение - ввести примерную оценку заказа для расчета онлайн, когда произойдет расчет и цена не будет привышать стоимости отраженной клиенту - производить списание средств с клиента и направлять в производство автоматически)
4. когда заказ берется в обработку менеджером? когда заказ рассчитан или до расчета?
5. Зачем менеджер вообще берет заказы? Почему не автопматизировать?
Глоссарий:
* Онлайн-магазин — написан на Vue и Java Spring Boot.
* CRM — SPA-приложение, фронтэнд написан на Vue, бэкенд — на Java Spring Boot.
* MES — SPA-приложение, фронтенд написан на React, бэкенд — на C#.
* SLA заказов - какой SLA? исходя из истори 2-3мин
* SLA API - какой SLA? предположим, что и как у заказов 2-3мин
* dev, release и prod. - контуры
* Internet Shop - магазин (далее - Shop)
* НТ - нагрузочное тестирование

Дисклеймеры:
1. ограничение производства -  2х кратный рост. Ограничение не учитывается в решении.

Начальное состояние: 
расчет стоимости 2-3мин (завист от кол-ва полигонов в 3д модели (размера?))

Изменение: 
1. рост - текущий год на 100 в мес больше чем в предыдущем, рост линейный
Проблемы: 
* SLA заказов (несколько месяцев вместо 3х недель). Производство справляется может обеспечит2х кратный рост. Проблема на стороне приклада.

2. открытие апи - бурный рост
Проблемы: 
* SLA заказов - Увеличение количества просроченных заказов
* SLA API - не получаеют заказы клиенты
* MES - долго прогружается страница с заказами
* SLA API - потеря клиентов за месяц использования

Требования:
1. MES - обеспечить быстрое отображение новых заказов (что такое новый заказ?)


Инфра:
1. сервис в облаке 
2. Приложение - 1 инстанс
3. БД - один истанс на сервис 

### Анализ схемы
1. нет систем мониторинга, не ясна нагрузка, ошибки, SLA запрос/ответ
2. нет балансировщиков - не ясна возможэность горизонтального масштабирования (и для MES и для CRM)
3. нет разщделение на Суб-домены - CRM и Shop смотрят в одну БД, что может свидетельствовать о монолитном решении  
4. MES API занимается длительной процедурой калькуляции - возможная проблема ответсвенности сервисов 
5. 1 инстанс на контейнер - монолит?
6. отсутвие регрессионного тестирвоания/Автотестов
7. отсутвие автоматической публикации изменений на Препрод и Прод

### Инициативы  

#### В порядке приоритета 1- наибольший приоритет

1. Определение проблемных зон - Мониторинг:
    1.1. Определение метрик для мониторинга и пороговые значения
    1.2. Разворачивание мониторинга и логирования 
    1.3. Настройка метрик и пороговых значений (включая дашборды и оповещения)
Результат: Выявление замедлений/длительных ответов/Наличия ошибок в конкретных сервисах
2. Определение причин - Логирование:
    2.1. Разворачивание логирвоания
    2.2. Модификация сервисов для указания запросов/ответов сквозных идентификаторов
    2.3. Настройка сбора и их анализ на предмет выявления проблем/ошибок
Результат: Определение причин проблем (включая "потерю" заказов)
3. Анализ результатов мониторинга и логирования, принятие решений по модификации приложения, включая приоритеты модификации
Цель: стабилизация текущего решения 
Результат: исключение потери заказов
Вопрос: возможна проблема в том, что сотрудники не видят информацию о дате заказа и сколько осталось до его завершения - остаются необработанные заказы.
4. Анализ действюзих процессов. Возможна опитимизация как времени ожидания клиента, так и автоматизация обработки заказов
Проблемы в бизнес-процессах могут не исправляться техническими средствами
Цель: дешевые и быстрые оптимизации бизнес-процессов могут улучшить пользовательский опыт и исключить "человеческий фактор"
5. Выработка целевого решения
Цель: достижение SLA, возможности роста 
Результат: SLA выдерживается при росте клиентов за счет горизонтального масштабирования
6. Процессы производства:
    5.1. Регрессионное тестирование
    Цель: поставки не содержат ошибки, влияющие на пользовательский опыт
    5.2. Стенд НТ
    Цель: исключение деградации в результате ошибок
    5.3. Настройка CI/CD для Препрод/Прод
    Цель: исключение "человеческого фактора" при публикации
    5.4. Автотесты для регресса
    Цель: ускорение процессов тестирования и исключение "человеческого фактора"
    5.5.  Стенд Хотфикс (тестирование исправлений на стенде соответсвующему проду)
    Цель: тестирование исправлений в среде, соответсвующей Проду, не нарушая производсвенный цикл

#### За пол года

1. Система "прозрачная" настроены мониторинг и логирование. Настроены пороги. 
Четко видны проблемные места. Выявление ошибки не занимает времени
2. Выделены Субдомены. Функции распределены по субдоменам. 
3. Стабилизирован расчет стоимости Заказов и процесс обработки заказа
    3.1. MES API - функция расчета стоимости заказа выделена в отдельный микросервис с возможностью горизонтального масштабирования. Выделена отдельная БД для расчета стоимости (возможно добавлен кэш - здесь требуется исследование, какие данные при расчете использу.тся)
    3.2. MES API - функции работы с заказами не зависят от расчета, используют собственную БД. Добавлен кэш списка заказов используя паттерн Write Through (требуется обеспечить синхронизацию между сотрудниками по вызятым и новым заказам). 
    3.3. Разделена зависимость между Shop и CRM: ShopDB разеделена между интерне-магазиром и CRM. Заказы из магазина попадают в CRM в асинхронном режиме. Что позволит стабилизировать/масштабировать системы по отдельности. Главное: не терять заказы на этапе получения от клиентов.
4. Исключена потеря заказов
    4.1. Метрика длительности ожидания заказа у менеджеров настроена, есть пороговое зн-е (алерты отсылаются руководителю)
    4.2. Работа с заказами менеджеров оптимизирована за счет пункта 3.
5. Устранены технические проблемы потери закаов
    За счет мониторинга выявлены места, где технически могли теряться заказы (например очередь сообщений из магазина).
    Устранение зависит от выявленной проблемы
6. Есть понимание запаса возможной нагрузки системы (провдены НТ). 
    В соответсвии с возможностями системы выставлены пороговые зн-я, при достижении которых производится масштабирование либо применяются паттерны типа backpressure

#### Если требуется выбрать 3 пункта

1. Мониторинг и логирование - выясняем где основне проблемы
2. Выработка целевого решения - определяем какие изменения необходимо внести, чтобы убрать наибольше проблемы
3. Устранение наиболее критичных проблем (вероятно, требуется подтверждения метрикеми) в части разделения Субд ShopDB и MES DB и сервисов Shop и CRM. При этом будет устранена сильная связанность сервисов, отвечающих за разные функции. Появится возможность масштабирвоания этих функций.




   

