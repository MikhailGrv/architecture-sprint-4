# Выбор и настройка мониторинга в системе

## Мотивация

1. "Прозрачность" системы позволяет предотвращать сбои/отказы системы
2. Пользовательский опыт - измерение метрик, позволяет структурировать и измерить понятия "работает", "тормозит", "не работает" 
3. Позволяет измерить Стабильность системы - измерить SLA
4. Позволяет сократить на устранение проблем за счет уменьшения затрат на поиск и выявление проблемы.

## Выбор подхода к мониторингу

Подход к выбору:
Смотрим специфические метрики, которые отличают каждый метод и куда в наибольшей степени применимо.

Основные процессы:
1. Получение закзов (Апи+Интернет магазин)
2. Обработка заказов CRM и MES (в части заказов)
3. Расчет стоимости заказа (MES в части расчта стоимости)
4. Производство - не участвет в мониторинге, будет достаточно обеспечить гарантии доставки сообщений 
   

### USE

    Utilization (утилизация) — это среднее время, которое ресурс занят работой. Измеряется в процентах.
    Saturation (насыщенность) — объём работы, которую ресурс не может выполнить и вынужден откладывать (например, в очередь), чтобы сохранять работоспособность. Насыщенность можно измерить как длину очереди.
    Errors (ошибки) — количество ошибок.

Даннный метод подойдет для фунции расчета стоимости заказов,
Так как здесь важна насыщенность сревиса и оптимальное распределенпие ресурсов сервиса, т.к. процедура дляительная и (преположительно) ресурсоемкая. Также, есть возможность "размазать" по времени выполенение операций.

Для процесса получения и обработки заказа данный метод не будет эффеуктивен, т.к. главная потребность в быстрой реакции системы. Чего данный метод не показывает.


### Четыре золотых сигнала

    Задержка — **это время, которое уходит на доставку запроса по сети от отправителя к получателю.
    Трафик — это показатель активности пользователей в вашем приложении. Его можно измерить с помощью любого высокоуровневого системного показателя. В веб-приложениях трафик обычно считают как количество HTTP-запросов в секунду.
    Ошибки — это частота неудачных запросов. Сюда относятся как явные ошибки (например, ошибки с кодом 500), так и неявные — например, статус запроса 200, но контент доставили неправильно.
    Насыщенность — этот параметр показывает, насколько «заполнена» ваша система. Насыщенность напрямую связана с показателем использования системы, но иногда её сложно измерить. Сбои могут возникнуть даже тогда, когда система не загружена на сто процентов. Поэтому важно определить целевой уровень использования.

Подойдет для обработки заказов, мониторятся покаазатели внутри приложения (интеграции между компонентами). Важно знать, нет ли каких-либо сетевых проблем (Задержка, Трафик) и насыщенность (например в части наполнения очередей между компонентами системы)

Не подойдет для Расчет стоимости заказа (MES в части расчта стоимости), где основной упор на насыщенность и утилизацию (длительные операции)

Для получения заказов избыточна, т.к. задержку от клиента до системы затруднительно посчитать, также использование API сокращает показатель Траффик до Request Rate - больше подойдет RED и нет показателя Duration, что критично для клиента

### RED

    Requests Rate — частота запросов,
    Errors — ошибки,
    Duration — длительность.

Подойдет для Получение закзов, так как критичный для клиентов отклик системы или длительность запросов - Duration, также есть Reuest 
Rate, что показывает активность польтзователей и возможно выявление часов "пик"

Не подойдет для Обработки заказов, где требуется следить за интеграциями и сервисами, участвующими в оббработке, от которых зависит производительность системы

Не подойдет для расчета стоимости заказов, т.к. не говорит о загрузке системы и скопившихся очередях.

## Метрики
Только ключевые метрики, базове метрики сервисов - если деньги будут
Мониторить хорошо все возможные метрики, чтобы была возможность расследовать инциденты и перестраивать дашборды
1. Получение закзов (Апи+Интернет магазин)
Бизнес-метрики:
* Поступившие заказы. Мониторится как запросы на API создания заказа.
* Принятые заказы + длительность ответа. Мониторится как 200 на запрос на API создания заказа.

Технические метрики:
* Number of requests (RPS) for internet shop API (Приоритетная метрика, отслеживание нагрузки на сервис, выявление DDOS)
* Number of requests (RPS) per user for internet shop API (Приоритетная метрика, отслеживание нагрузки на сервис, поведение пользователей)
* Number of connections for shop db instance (Приоритетная метрика, смотрим чтобы не возникло отказа БД по ограничению)
* Memory Utilisation for shop db instance (Приоритетная метрика, смотрим, чтобы БД не начала свопить/замедлять запросы)
* Response time (latency) for shop API (Приоритетная метрика, увеличение длительности ответа сведельсвует о возникающих проблемах системы)
* Size of shop db instance (Приоритетная метрика, на предмет отказа БД)
* Size of S3 storage (Приоритетная метрика, на предмет отказа Сервиса)
* Number of HTTP 200 for shop API (Приоритетная метрика, корелляция с RPS, смотрим что система "жива")
* Number of HTTP 500 for shop API (Приоритетная метрика, частота возникновения ошибок может свидетельствовать об отказе системы, отражает на клиентский опыт)
* Number of simultanious sessions for shop API (Приоритетная метрика, может выявить приближения отказа в обслуживании)
* Kb tranferred (received) for shop API (не очень приоритеная метрика, можно отказаться)
* Kb provided (sent) for shop API (Возможно не требуется, посмотреть по процессу что мы отдаем клиенту)?
* CPU % for shop API (Приоритетная метрика, базовая метрика оценки "жива" системы)
  

2. Обработка заказов CRM и MES (в части заказов)
Бизнес-метрики:
* количество поступивших заказов
* количество новых заказов
* количество обработанных заказов
* количество необработанных заказов с истекающим сроком
Строятся на основе показаний из БД 

Технические метрики:
* Number of dead-letter-exchange letters in RabbitMQ (Приоритетная метрика, определяем зависание закзов в очереди)
* Number of message in flight in RabbitMQ (Приоритетная метрика, определяем рост нагрузки и возможный отказ системы)
* Number of requests (RPS) for CRM API (Приоритетная метрика, определяем напгрузку)
* Number of requests (RPS) for MES API (Приоритетная метрика, определяем напгрузку)
* Number of requests (RPS) per user for CRM API (Приоритетная метрика, определяем поведение пользователя)
* Number of requests (RPS) per user for MES API (Приоритетная метрика, определяем поведение пользователя)
* CPU % for CRM API (Приоритетная метрика, определяем сбой сисемы)
* CPU % for MES API (Приоритетная метрика, определяем сбой сисемы)
* Memory Utilisation for CRM API (Приоритетная метрика, определяем сбой сисемы)
* Memory Utilisation for MES API (Приоритетная метрика, определяем сбой сисемы)
* Memory Utilisation for MES db instance (Приоритетная метрика, определяем сбой сисемы)
* Memory Utilisation for CRM db instance (до оптимизации Memory Utilisation for shop db instance, определяем сбой сисемы)
* Number of connections for CRM db instance (до оптимизации Number of connections for shop db instance, определяем сбой сисемы)
* Response time (latency) for CRM API (Приоритетная метрика, увеличение длительности ответа сведельсвует о возникающих проблемах системы)
* Response time (latency) for MES API (Приоритетная метрика, увеличение длительности ответа сведельсвует о возникающих проблемах системы)
* Size of S3 storage (выявление необходимости почистить)
* Size of shop db instance (Приоритетная метрика до разделения сервисов. Потом БД CRM, определяем сбой сисемы)
* Size of MES db instance (Приоритетная метрика до разделения сервисов. Потом БД для заказов, определяем сбой сисемы)
* Number of HTTP 200 for CRM API  (Приоритетная метрика, корелляция с RPS, смотрим что система "жива")
* Number of HTTP 200 for MES API (Приоритетная метрика, корелляция с RPS, смотрим что система "жива")
* Number of HTTP 500 for CRM API (Приоритетная метрика, частота возникновения ошибок может свидетельствовать об отказе системы, отражает на клиентский опыт)
* Number of HTTP 500 for MES API (Приоритетная метрика, частота возникновения ошибок может свидетельствовать об отказе системы, отражает на клиентский опыт)
* Number of simultanious sessions for CRM API (Приоритетная метрика, определяем сбой сисемы)
* Number of simultanious sessions for MES API (Приоритетная метрика, определяем сбой сисемы)
* Kb tranferred (received) for CRM API (определяем состояние каналов и инетграций)
* Kb tranferred (received) for MES API (определяем состояние каналов и инетграций)
* Kb provided (sent) for CRM API (определяем состояние каналов и инетграций)
* Kb provided (sent) for MES API (определяем состояние каналов и инетграций)

1. Расчет стоимости заказа (MES в части расчта стоимости)
   
* Number of dead-letter-exchange letters in RabbitMQ (Приоритетная метрика, определяем рост нагрузки и возможное нарушение SLA)
* Number of message in flight in RabbitMQ (Приоритетная метрика, определяем рост нагрузки и возможное нарушение SLA)
* Number of requests (RPS) for MES API (до оптимизации важно)
* Number of requests (RPS) per user for MES API (до оптимизации важно)
* CPU % for MES API (до оптимизации важно, определяем сбой сисемы)
* Memory Utilisation for MES API (Приоритетная метрика, определяем сбой сисемы)
* Memory Utilisation for MES db instance (Приоритетная метрика, определяем сбой сисемы)
* Number of connections for MES db instance (до оптимизации важно, после оптимизации как защита от косяка разработчика)
* Response time (latency) for MES API (до оптимизации важно)
* Size of MES db instance (Приоритетная метрика)
* Number of HTTP 200 for MES API (после оптимизации - не требуется, сервис будет сам разгрбать очередь)
* Number of HTTP 500 for MES API (после оптимизации - не требуется, сервис будет сам разгрбать очередь)
* Number of simultanious sessions for MES API (после оптимизации - не требуется , сервис будет сам разгрбать очередь)
* Kb tranferred (received) for MES API (здесь скорее заменить на поступивышие и выполеннные задачи)
* Kb provided (sent) for MES API (здесь скорее заменить на поступивышие и выполеннные задачи)

## План действий

1. Равзернуть решение типа Prometeus + Grafana (можно использовать аналоги или посмотреть что предоставляет Yandex Cloud)
Исхожу из Prometeus + Grafana, т.к. наиболее знакомое решение.
2. Настроить сбор и отображение метрик
3. Настроить пороговые значения для метрик
4. Настроить оповещения

## Дополнительное задание

Показатели насыщенности системы (для текущей системы) как минимум утилизация CPU, Memory, DB Size для Баз данных. 
Необъодимо выставитьт пороговые зн-я, при привышении которых должны включаться разные сценарии. Например:
1. Базовый сценарий - оповещение поддержки
2. Релиазация CircuitBreaker или Backpressure - поволиз запуцскать эти сценарии в автоматическом режиме, что не позволит получить отказ сервиса. При этом заводить инцидент для дальнейшего исследования. Данные, метрики, логи на момент возникновения (+- период) необходлимо сохранить в отдельное хранилище.

Также, при реализации микросервисной архитектуры возможна настройка на поднятие инстансов сервисов (горизонтальное масштабирование).
Пример: в случае повышения "Number of message in flight in RabbitMQ " возможно развернуть еще инстанс сервиса расчета стоимости заказа.
Еще пример: при повышении "Number of requests (RPS) for internet shop API " - здесь по идее должен быть настроен RateLimit что будет отбивать запросы, но мы можем развернуть еще инстансы или добавить кэш , тем самым повысить пропускную способность 



