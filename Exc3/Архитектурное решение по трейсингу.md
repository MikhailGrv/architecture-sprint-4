# Архитектурное решение по трейсингу

## Места - проблемные места, которые подлежат трейсингу

Дисклеймер: 
Добавляем трассировку - доавляем компонет/библиотеку для трассировки, модифицирем спригбут или делаем доработки в коде.
За исключением RabbitMQ - там делаем специфические настройки согласно инстрйкции.

Основные процессы - Получение и обработка заказа. Их требуется трейсить.
Ключем будет являтся ID или номер заказа.
Предполагаем, что в каждом ссообщении фигурирует этот ключ, в иноми случае требуется доработка интеграции.
1. Заказ появляется в Shop API - добавялем трассировку. 
2. Заказ забирает CRM API - добавляем трассировку. 
3. Заказ направляется в RabbitMQ -  добавляем трассировку (если это возможно).
4. Заказ забирает MES API  (обрабатывает и рассчитывает стоимость) - добавляем трассировку
Трассировку еще следует добавить в интерфейс Производства, но этот этап сейчас не рассматриваем

В результате мы видим полный путь заказа от поступления до проиводства. Можем определить где сейчас находится заказ.

Отдельно следует отметить, что можно подвесить трассировки на Интернет Магазин, CRM, MES и смотреть запросы пользователй, но это не позволит решить задачу зависания/пропажи заказов, но позволит выявить иные проблемы с обработкой пользовательских запросов.

## Мотивация

Внедрение трейсинга позволит
1. ускорить выявление проблемы (сократить время ответа клиентам на претензию до Онлайна) 
2. принять меры для выполнения заказа (выдержать SLA). Здесь требуется выявление в мониторинге фактов пропажи/зависания заказов для начала расследования до обращения клиента.
3. "удешивить" спеиалистов сопровождения/передать функцию поиска заказа напрмер Операторам 
4. Бизнес-сервис Обработка закзов, бизнес-метрика количество поступивших заказов в разрезе каналов позволит контролировать активность клиентов/партнеров
5. Бизнес-сервис Обработка закзов, бизнес-метрика количество не обработанных заказов, количество обработанных заказов в разных разрезах позволит оценить эффектиность работы сотрудников
6. Бизнес-сервис Обработка закзов, бизнес-метрика длительность ожидания необработанных заказов позволит выявить проблему обработки заказа (влияние на SLA длительность исполнения заказа) и принять орг. решения (например увеличение штата сотрудников, которые обрабатывают заказы)
7. Бизнес-сервис Обработка закзов, бизнес-метрика длительность исполнения заказов (от принятия заказа до доставки). Позволяет оценить исполнгение SLA перед клиентами и как следствие удовлетваренность клиентов сервисом (не включает качество самого продукта).

## Предлагаемое решение

Решение предлагается на jaeger (причина: более знакома данная технология). Однако можно рассмотреть альтернативы.
Коритерии: исполнение задачи трейсинга, влияние на производительность сервисов, стоимость решения.
Решение отражено в схеме jewerly_c4_model.drawio 
Для каждого сервиса потребуется подключить Библиотеки, которые будут отправлять данные в Коллектор, открыть сетевые доступы.
Важно проверить, что ключевые сообщения с передачей заказа должны содержать ключ (Ключем будет являтся ID или номер заказа). По которому будем искать

Важно2: срок хранения трейса должен быть не менее 2х недель (длительность выполнения заказа, когда клиент может обратиться)
не более 4х недель (клиент уже не будет ждать свой заказ)
Это ограничение будет определять размер жесткого диска для хранения информации, может быть рассыитан.
CPU и RAM требуемые системе определяются по спецификации системы.

## Компромиссы

Делаем трейсинг только заказаов, как ключевой информации. 
Тресинг дргих запросов не принесет решения проблем с заказами, но позволит решать другие проблемы.

## Безопасность

1. Персональные данные/платежные данные должны храниться в маскированном виде
2. Доступ к трейсу необходимо обеспечить действющим польтзователям с ролью Администратор и Оператор и их аутентификацию
3. Доступ должен быть из LAN компании

## Дополнительное задание

Автоматический мониториг прохождения заказа
Решением не занимался, но предположу вариант. 
Допущенеия:
1. jaeger умеет сообщать есть вообщение или нет
2. jaeger умеет группировать сообщения по ключу и сообщать их количество (применять фильтры)
3. количество шагов (с фильтром на уникальность) определяет состояние заказа
Решение: 
Натроить например Prometeus на получение заказов с датой поступления (запрос на создание) и количеством прошедших шагов и jaeger
Настроить порог: при появлении заказа с датой создания + n(времени) < текущей даты и количестом шагов, не соответсвующему обработанному заказу - алертить.

